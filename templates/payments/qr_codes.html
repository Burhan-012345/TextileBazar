<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Codes Management - Textile Bazar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='auth.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* QR Code Management Styles */
        .qr-management-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: #0066CC;
            margin-bottom: 10px;
        }
        
        .page-header p {
            color: #666;
            font-size: 16px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .stat-card h3 {
            font-size: 28px;
            margin: 10px 0;
            color: #0066CC;
        }
        
        .stat-card p {
            color: #666;
            margin: 0;
        }
        
        .stat-card.upi { border-left: 4px solid #0066CC; }
        .stat-card.upi i { color: #0066CC; }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #0066CC;
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #0052a3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid #0066CC;
            color: #0066CC;
        }
        
        .btn-outline:hover {
            background-color: #0066CC;
            color: white;
        }
        
        .qr-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .qr-code-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .qr-code-card:hover {
            transform: translateY(-5px);
        }
        
        .qr-card-header {
            padding: 20px;
            background: linear-gradient(135deg, #0066CC, #004C99);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qr-card-header h4 {
            margin: 0;
            font-size: 18px;
        }
        
        .qr-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-upi { background: rgba(255,255,255,0.2); color: white; }
        
        .qr-card-body {
            padding: 20px;
        }
        
        .qr-image-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .qr-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .qr-details {
            text-align: center;
        }
        
        .qr-details p {
            margin: 5px 0;
            color: #666;
        }
        
        .qr-details strong {
            color: #333;
        }
        
        .qr-card-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.active { background-color: #28a745; }
        .status-dot.inactive { background-color: #dc3545; }
        
        .qr-actions {
            display: flex;
            gap: 5px;
        }
        
        .qr-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .qr-btn.view { background-color: #0066CC; color: white; }
        .qr-btn.view:hover { background-color: #0052a3; }
        
        .qr-btn.edit { background-color: #ffc107; color: #212529; }
        .qr-btn.edit:hover { background-color: #e0a800; }
        
        .qr-btn.delete { background-color: #dc3545; color: white; }
        .qr-btn.delete:hover { background-color: #c82333; }
        
        .qr-btn.toggle { background-color: #6c757d; color: white; }
        .qr-btn.toggle:hover { background-color: #5a6268; }
        
        .qr-btn.default { background-color: #28a745; color: white; }
        .qr-btn.default:hover { background-color: #218838; }
        
        .no-qr-codes {
            text-align: center;
            padding: 50px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .no-qr-codes i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .no-qr-codes h3 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .no-qr-codes p {
            color: #999;
            margin-bottom: 20px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            background: #0066CC;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #0066CC;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }
        
        .upload-area {
            border: 2px dashed #0066CC;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: rgba(0,102,204,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: rgba(0,102,204,0.1);
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .upload-label i {
            font-size: 48px;
            color: #0066CC;
        }
        
        .qr-preview {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .qr-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .qr-codes-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
            }
        }
        
        @media (max-width: 480px) {
            .qr-codes-grid {
                grid-template-columns: 1fr;
            }
            
            .qr-card-footer {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .qr-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body class="auth-body">
    <div class="qr-management-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-qrcode"></i> QR Codes Management</h1>
            <p>Manage your UPI payment QR codes</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card upi">
                <i class="fas fa-wallet"></i>
                <h3>{{ qr_stats.total_qr_codes or 0 }}</h3>
                <p>Total QR Codes</p>
            </div>
            <div class="stat-card upi">
                <i class="fas fa-check-circle"></i>
                <h3>{{ qr_stats.active_qr_codes or 0 }}</h3>
                <p>Active QR Codes</p>
            </div>
            <div class="stat-card upi">
                <i class="fas fa-star"></i>
                <h3>{{ qr_stats.default_qr_codes or 0 }}</h3>
                <p>Default QR Codes</p>
            </div>
            <div class="stat-card upi">
                <i class="fas fa-money-bill-wave"></i>
                <h3>₹{{ qr_stats.total_payments or 0 | format_rupees }}</h3>
                <p>Total Payments Received</p>
            </div>
        </div>

        <!-- QR Codes Grid -->
        {% if qr_codes %}
        <div class="qr-codes-grid">
            {% for qr in qr_codes %}
            <div class="qr-code-card">
                <div class="qr-card-header">
                    <h4>{{ qr.display_name }}</h4>
                    <span class="qr-type-badge badge-upi">
                        UPI
                    </span>
                </div>
                
                <div class="qr-card-body">
                    <div class="qr-image-container">
                        {% if qr.qr_url %}
                            <img src="{{ qr.qr_url }}" alt="{{ qr.display_name }}">
                        {% else %}
                            <i class="fas fa-qrcode" style="font-size: 48px; color: #999;"></i>
                        {% endif %}
                    </div>
                    
                    <div class="qr-details">
                        {% if qr.upi_id %}
                        <p><i class="fas fa-wallet"></i> <strong>UPI ID:</strong> {{ qr.upi_id }}</p>
                        {% endif %}
                        <p><i class="far fa-calendar"></i> <strong>Created:</strong> {{ qr.created_at[:10] }}</p>
                        {% if qr.updated_at %}
                        <p><i class="fas fa-sync"></i> <strong>Updated:</strong> {{ qr.updated_at[:10] }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="qr-card-footer">
                    <div class="status-indicator">
                        <span class="status-dot {% if qr.is_active %}active{% else %}inactive{% endif %}"></span>
                        {% if qr.is_active %}Active{% else %}Inactive{% endif %}
                        {% if user.default_qr_id == qr.id %}
                        <span style="margin-left: 5px; color: #0066CC;">
                            <i class="fas fa-star"></i> Default
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="qr-actions">
                        <button class="qr-btn view" title="View" onclick="viewQR('{{ qr.id }}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        {% if user.default_qr_id != qr.id %}
                        <button class="qr-btn default" title="Set as Default" onclick="setDefaultQR('{{ qr.id }}')">
                            <i class="fas fa-star"></i>
                        </button>
                        {% endif %}
                        
                        <button class="qr-btn toggle" title="{% if qr.is_active %}Deactivate{% else %}Activate{% endif %}" 
                                onclick="toggleQRStatus('{{ qr.id }}')">
                            <i class="fas fa-power-off"></i>
                        </button>
                        
                        <button class="qr-btn delete" title="Delete" onclick="deleteQR('{{ qr.id }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-qr-codes">
            <i class="fas fa-qrcode"></i>
            <h3>No QR Codes Found</h3>
            <p>You haven't added any UPI payment QR codes yet. Add your first QR code to start accepting UPI payments!</p>
            <button class="btn btn-primary" onclick="openAddQRModal()">
                <i class="fas fa-plus"></i> Add Your First QR Code
            </button>
        </div>
        {% endif %}

        <!-- Payment Statistics (Optional) -->
        {% if payment_stats %}
        <div style="background: white; border-radius: 10px; padding: 20px; margin-top: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #0066CC; margin-bottom: 20px;">
                <i class="fas fa-chart-line"></i> Payment Statistics
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">₹{{ payment_stats.total_received|default(0)|format_rupees }}</div>
                    <div style="color: #666; font-size: 14px;">Total Received</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">₹{{ payment_stats.pending_amount|default(0)|format_rupees }}</div>
                    <div style="color: #666; font-size: 14px;">Pending</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0066CC;">{{ payment_stats.total_transactions|default(0) }}</div>
                    <div style="color: #666; font-size: 14px;">Total Transactions</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #6c757d;">{{ payment_stats.success_rate|default(0) }}%</div>
                    <div style="color: #666; font-size: 14px;">Success Rate</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Add QR Code Modal -->
    <div id="addQRModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Add UPI QR Code</h3>
                <button class="modal-close" onclick="closeAddQRModal()">&times;</button>
            </div>
            
            <form id="addQRForm" action="{{ url_for('payments_qr_codes') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="upload">
                
                <div class="modal-body">
                    <div class="form-group">
                        <label for="qr_type">Payment Type *</label>
                        <select class="form-control" id="qr_type" name="qr_type" required>
                            <option value="upi">UPI</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="display_name">Display Name *</label>
                        <input type="text" class="form-control" id="display_name" name="display_name" 
                               placeholder="e.g., Business UPI QR, Main Account QR" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="upi_id">UPI ID (Optional)</label>
                        <input type="text" class="form-control" id="upi_id" name="upi_id" 
                               placeholder="username@upi">
                        <small style="color: #666; font-size: 12px;">If you enter UPI ID, we can generate QR code automatically</small>
                    </div>
                    
                    <div class="form-group">
                        <label>QR Code Image (Optional)</label>
                        <div class="upload-area" onclick="document.getElementById('qr_image').click()">
                            <label class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload QR code image</span>
                                <span style="font-size: 12px; color: #666;">PNG, JPG, JPEG, GIF, SVG (Max 5MB)</span>
                                <input type="file" id="qr_image" name="qr_image" accept=".png,.jpg,.jpeg,.gif,.svg">
                            </label>
                        </div>
                        <div class="qr-preview" id="qrPreview">
                            <div style="color: #999; text-align: center;">
                                <i class="fas fa-image" style="font-size: 36px;"></i>
                                <p style="margin-top: 10px;">Preview will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save QR Code
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddQRModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View QR Code Modal -->
    <div id="viewQRModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> QR Code Details</h3>
                <button class="modal-close" onclick="closeViewQRModal()">&times;</button>
            </div>
            
            <div class="modal-body" id="qrDetailsContent">
                <!-- QR details will be loaded here -->
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="downloadQR()">
                    <i class="fas fa-download"></i> Download QR
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeViewQRModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        function openAddQRModal() {
            document.getElementById('addQRModal').style.display = 'flex';
        }
        
        function closeAddQRModal() {
            document.getElementById('addQRModal').style.display = 'none';
            resetAddForm();
        }
        
        function closeViewQRModal() {
            document.getElementById('viewQRModal').style.display = 'none';
        }
        
        function resetAddForm() {
            document.getElementById('addQRForm').reset();
            document.getElementById('qrPreview').innerHTML = `
                <div style="color: #999; text-align: center;">
                    <i class="fas fa-image" style="font-size: 36px;"></i>
                    <p style="margin-top: 10px;">Preview will appear here</p>
                </div>`;
        }
        
        // QR code preview
        document.getElementById('qr_image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('qrPreview');
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="QR Code Preview">`;
                }
                
                reader.readAsDataURL(file);
            }
        });
        
        // View QR code details
        function viewQR(qrId) {
            fetch(`/auth/qr-codes/${qrId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('qrDetailsContent').innerHTML = html;
                    document.getElementById('viewQRModal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading QR details:', error);
                    alert('Error loading QR code details');
                });
        }
        
        // Set default QR code
        function setDefaultQR(qrId) {
            if (confirm('Set this as your default QR code?')) {
                window.location.href = "{{ url_for('set_default_qr_code', qr_id=0) }}".replace('0', qrId);
            }
        }
        
        // Toggle QR code status
        function toggleQRStatus(qrId) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('payments_qr_codes') }}";
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'toggle';
            form.appendChild(actionInput);
            
            const qrIdInput = document.createElement('input');
            qrIdInput.type = 'hidden';
            qrIdInput.name = 'qr_id';
            qrIdInput.value = qrId;
            form.appendChild(qrIdInput);
            
            document.body.appendChild(form);
            form.submit();
        }
        
        // Delete QR code
        function deleteQR(qrId) {
            if (confirm('Are you sure you want to delete this QR code?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('payments_qr_codes') }}";
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'delete';
                form.appendChild(actionInput);
                
                const qrIdInput = document.createElement('input');
                qrIdInput.type = 'hidden';
                qrIdInput.name = 'qr_id';
                qrIdInput.value = qrId;
                form.appendChild(qrIdInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Download QR code
        function downloadQR() {
            const qrImg = document.querySelector('#qrDetailsContent img');
            if (qrImg) {
                const link = document.createElement('a');
                link.href = qrImg.src;
                link.download = 'qr-code.png';
                link.click();
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addQRModal');
            const viewModal = document.getElementById('viewQRModal');
            
            if (event.target == addModal) {
                closeAddQRModal();
            }
            if (event.target == viewModal) {
                closeViewQRModal();
            }
        }
    </script>
</body>
</html>